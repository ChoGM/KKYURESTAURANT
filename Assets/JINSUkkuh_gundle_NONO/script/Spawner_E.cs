using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using static UnityEditor.PlayerSettings;

public class Spawner_E : MonoBehaviour
{
    //inspector 창에서 유닛, 유닛확률, 포지션, 포지션 확률을 조정가능
    [Tooltip("포지션 별 확률 *순서는 돌격형 탱커, 방어형 탱커, 근거리 딜러, 원거리 딜러, 서포터 순으로함")]
    [SerializeField]
    float[] p_percentages = new float[5];//포지션 별 확률 *순서는 돌격형 탱커, 방어형 탱커, 근거리 딜러, 원거리 딜러, 서포터 순으로함

    int[] unitPosition = new int[5];//유닛 포지션

    [SerializeField]
    GameObject[] rush_tnak;//돌격형 탱커 포지션의 유닛 목록
    [SerializeField]
    float[] rush_tnak_percentage;//돌격형 탱커 포지션의 유닛별 소환 확률

    [SerializeField]
    GameObject[] guard_tnak;//방어형 탱커 포지션의 유닛 목록
    [SerializeField]
    float[] guard_tnak_percentage;//방어형 탱커 포지션의 유닛별 소환 확률

    [SerializeField]
    GameObject[] close_deal;//근거리 딜러 포지션의 유닛 목록
    [SerializeField]
    float[] close_deal_percentage;//근거리 딜러 포지션의 유닛별 소환 확률

    [SerializeField]
    GameObject[] long_deal;//원거리 딜러 포지션의 유닛 목록
    [SerializeField]
    float[] long_deal_percentage;//원거리 딜러 포지션의 유닛별 소환 확률

    [SerializeField]
    GameObject[] support;//서포터 포지션의 유닛 목록
    [SerializeField]
    float[] support_percentage;//서포터 포지션의 유닛별 소환 확률

    [Tooltip("최소값, 최대값")]
    [SerializeField]
    float[] cooltime = new float[2];//생성 쿹타임

    //[SerializeField]
    //Transform spawnPoint;//스포너

    public Transform pos;
    private float cool;
    private int gh = 0;
    private int unit_position;

    //아직 상대의 기지 체력 변수를 연결시켜놓지 않아 오류가 나지 않도록 정의만 해놓음
    //적군 기지 프로그래밍을 하는 팀원의 스크립트에서 체력변수를 가져올 것임
    //e_hp = ob.GetComponent <???> ().e_hp;
    private float e_hp = 7000;
    //위와 같음 한 열에 아군이 얼마나 존재하는지 (소환될떄 변수에 1씩 더하고 죽을때마다 1씩 감소시킬 예정)
    private int our_unit1 = 0;
    private int our_unit2 = 0;
    private int our_unit3 = 0;

    private float[] original_p = new float[5];

    private float timeAfterSpawn;

    // Start is called before the first frame update
    void Start()
    {
        change(original_p, p_percentages);

        cool = 3;
        timeAfterSpawn = 0f;
    }

    // Update is called once per frame
    void Update()
    {
        timeAfterSpawn += Time.deltaTime;

        //적 기지의 체력이 일정 이하일 경우 적용
        if (e_hp < 3500)
            gh = 2;

        if (timeAfterSpawn >= cool)
        {
            //세 라인 중 위치 정하기
            GetRow();
            Transform objectTransform = gameObject.GetComponent<Transform>();

            //생성원리 = 포지션 선택 ex)돌격형 탱커, 원거리 딜러 등등 -> 해당 포지션의 적군 선택 -> 소환 및 해당 포지션 확률 조정

            //1. 확률에 따라 소환되는 유닛 포지션 선택
            //0 = 돌격형 탱커, 1 = 방어형 탱커, 2 = 근거리 딜러, 3 = 원거리 딜러, 4 = 서포터 
            unit_position = GetRandom(p_percentages, 5, 5);
            if (unit_position == 0)
            {
                //2. 결정된 유닛 포지션의 적군을 확률에 따라 소환
                Instantiate(rush_tnak[GetRandom(rush_tnak_percentage, rush_tnak_percentage.Length, rush_tnak.Length)], pos.position, transform.rotation);

                change(p_percentages, original_p);

                //3. 다음번 소환에 같은 유닛 포지션이 연속으로 여러변 소환되는 것을 방지 하기위해 유닛 포지션별 확률을 조정
                //Percents_Adj(unit_position, rt, gt, cd, ld, sp);
            }

            else if (unit_position == 1)
            {
                Instantiate(guard_tnak[GetRandom(guard_tnak_percentage, guard_tnak_percentage.Length, guard_tnak.Length)], pos.position, transform.rotation);
                change(p_percentages, original_p);
                Percents_Adj(unit_position);
            }

            else if (unit_position == 2)
            {
                Instantiate(close_deal[GetRandom(close_deal_percentage, close_deal_percentage.Length, close_deal.Length)], pos.position, transform.rotation);
                change(p_percentages, original_p);
                Percents_Adj(unit_position);
            }

            else if (unit_position == 3)
            {
                Instantiate(long_deal[GetRandom(long_deal_percentage, long_deal_percentage.Length, long_deal.Length)], pos.position, transform.rotation);
                change(p_percentages, original_p);
                Percents_Adj(unit_position);
            }

            else
            {
                Instantiate(support[GetRandom(support_percentage, support_percentage.Length, support.Length)], pos.position, transform.rotation);
                change(p_percentages, original_p);
                Percents_Adj(unit_position);
            }

            //쿨타임 정하기
            //적 기지의 체력이 일정 이하일 경우 쿨타임을 줄이기(자주 소환되도록 -> 난이도 상승)
            cool = Random.Range(cooltime[0] - gh, cooltime[1] - gh);
            timeAfterSpawn = 0f;
        }
    }

    //라인을 정하는 함수
    private void GetRow()
    {
        int a = 0, b = 0, c = 0;
        int line;
        float[] line_percentages = { 30, 30, 30 };

        //열당 존재하는 아군 유닛수가 일정 이상일 시 해당 라인에 스폰될 확률 증가
        if (our_unit1 > 5)
            a = 40;
        if (our_unit2 > 5)
            b = 40;
        if (our_unit3 > 5)
            c = 40;
        line_percentages[0] = 30 + a;
        line_percentages[1] = 30 + b;
        line_percentages[2] = 30 + c;

        Transform objectTransform = gameObject.GetComponent<Transform>();
        line = GetRandom(line_percentages, 3, 3);

        //각 열의 좌표를 입력할 예정
        if (line == 0)
        {
            objectTransform.position = new Vector2(5.0f, 1.0f);
        }
        if (line == 1)
        {
            objectTransform.position = new Vector2(5.0f, 0.0f);
        }
        if (line == 2)
        {
            objectTransform.position = new Vector2(5.0f, -1.0f);
        }
    }

    //유닛 포지션별 확률을 조정하는 함수
    //이것과 비슷한 형식으로 적 기지 체력이 일정 이하일 결우 고 코스트의 강한 유닛의 출현 빈도가 높도록 확률 설정 가능 (상의중)

    private void change(float[] original_p, float[] p_percentages)
    {
        for(int i = 0; i < 5;  i++)
        {
            original_p[i] = p_percentages[i];
        }
    }

    private void Percents_Adj(int i)
    {
        float a = 1, b = 1, c = 1, d = 1, e = 1;
        if (i == 0)
            a = 0.6f;
        else if (i == 1)
            b = 0.6f;
        else if (i == 2)
            c = 0.6f;
        else if (i == 3)
            d = 0.6f;
        else
            e = 0.6f;
        p_percentages[0] = p_percentages[0] * a;//돌격형 탱커
        p_percentages[1] = p_percentages[1] * b;//방어형 탱커
        p_percentages[2] = p_percentages[2] * c;//근거리 딜러
        p_percentages[3] = p_percentages[3] * d;//원거리 딜러
        p_percentages[4] = p_percentages[4] * e;//서포터
    }

    //확률 계산기 함수

    private int GetRandom(float[] percentages, int p_count, int o_count)
    {
        float random = Random.Range(0f, 1f);
        float numForAdding = 0;
        float total = 0;
        for (int i = 0; i < p_count; i++)
        {
            total += percentages[i];
        }

        for (int i = 0; i < o_count; i++)
        {
            if (percentages[i] / total + numForAdding >= random)
            {
                return i;
            }
            else
            {
                numForAdding += percentages[i] / total;
            }
        }
        return 0;
    }
}